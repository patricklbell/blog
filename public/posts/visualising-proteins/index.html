<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><title>Modifying Spline Algorithms to Draw Proteins with WebAssembly - Patrick Bell</title><meta property="og:title" content="Modifying Spline Algorithms to Draw Proteins with WebAssembly - Patrick Bell"><meta property="og:type" content="article"><meta property="og:image" content="/haemoglobin_chains.png"><meta property="og:url" content="https://patricklbell.xyz/posts/visualising-proteins/"><meta property="og:description" content="The homepage of Patrick Bell's blog"><meta name=Description property="description" content="The homepage of Patrick Bell's blog"><meta property="keywords" content="graphics, mathematics"><link rel=stylesheet href=https://patricklbell.xyz/css/style.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png href=/favicon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link href=https://patricklbell.xyz/index.xml type=application/atom+xml rel=alternate title="Sitewide Atom feed"><meta name=theme-color content="#ffffff"><script>function updateMode(){localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function toggleMode(){localStorage.theme==="dark"?localStorage.theme="light":localStorage.theme="dark",updateMode()}window.onload=updateMode();function toggleMenu(){let e=document.getElementById("navbar-default");e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")}</script></head><body><header class="md:px-0 px-2"><nav><div class="container flex flex-wrap justify-between items-center mx-auto"><div class="nav-main my-2.5"><a href=https://patricklbell.xyz/ class="nav-title py-2.5 text-2xl
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline
text-zinc-600 dark:text-zinc-300 hover:border-b-0">Patrick Bell</a></div><button type=button onclick=toggleMenu() class="inline-flex items-center p-2 ml-3
text-sm text-gray-500
rounded-lg md:hidden hover:bg-gray-100
focus:outline-none focus:ring-2
focus:ring-gray-200 dark:text-gray-400
dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls=navbar-default aria-expanded=false>
<span class=sr-only>Open main menu</span><svg class="w-6 h-6" aria-hidden="true" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></button><div class="hidden w-full md:block md:w-auto" id=navbar-default><ul class="grid md:grid-flow-col items-center justify-between text-lg my-2.5"><li class="p-2.5 md:first:pl-0 dark:border-zinc-500 md:border-none list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/posts/><span class="py-1
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline">Posts</span></a></li><li class="p-2.5 md:first:pl-0 dark:border-zinc-500 md:border-none list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/tags/><span class="py-1
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline">Tags</span></a></li><li class="p-2.5 md:first:pl-0 dark:border-zinc-500 md:border-none list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/about/><span class="py-1
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline">About</span></a></li><li class="h-7 pl-2.5 pr-0 list-none"><button type=button onclick=toggleMode() class=h-full aria-label="Toggle between dark and light mode">
<img class="h-7 w-7 max-h-full mb-1.5 p-1.5 hidden dark:inline" id=ligh-mode-button-img alt="A sun icon for switching to light mode" src=https://patricklbell.xyz/img/light_mode.svg>
<img class="h-7 w-7 max-h-full mb-1.5 p-1.5 inline dark:hidden" id=dark-mode-button-img alt="A moon icon for switching to dark mode" src=https://patricklbell.xyz/img/dark_mode.svg></button></li></ul></div></div></nav><style>.link-underline{border-bottom-width:0;background-size:0 3px;background-position:0 100%;background-repeat:no-repeat;transition:background-size .1s ease-in-out}.link-underline-black{background-image:linear-gradient(transparent,transparent),linear-gradient(#000,#000)}.link-underline-white{background-image:linear-gradient(transparent,transparent),linear-gradient(#fff,#fff)}.link-underline:hover{background-size:100% 3px;background-position:0 100%}</style></header><main class="content h-card container mt-2 m-auto
leading-loose md:px-0 px-2 z-0 break-words" role=main><article class="article h-entry" itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><div class=title-container><h1 class="article-title p-name" itemprop=name>Modifying Spline Algorithms to Draw Proteins with WebAssembly</h1><div class="flex justify-between items-center"><a class="text-lg text-gray-600 dark:text-gray-400 border-none u-url" href=https://patricklbell.xyz/posts/visualising-proteins/><time itemprop=datePublished class=dt-published datetime=2022-12-27T00:00:00Z content="2022-12-27T00:00:00Z">2022.12.27</time></a>
<a class="text-gray-600 dark:text-gray-400 text-right border-none p-author h-card" rel=author href=https://patricklbell.xyz/ itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>Patrick Bell</span></a></div></div><div class="article-content e-content" itemprop=articleBody><p><em>This post is a modified version of a presentation I gave about my protein visualiser <a href=https://patricklbell.github.io/chemical_visualizer/>available online</a> with WebAssembly</em></p><p>Proteins are the building blocks of our cells and allow for the incredibly complicated behaviours of the body. Knowing how important proteins are then, models of protein&rsquo;s structures allow scientists to quickly compare and understand a protein&rsquo;s features. One protein model is the <a href=https://en.wikipedia.org/wiki/Ribbon_diagram>ribbon diagram</a> which has been around since the 1980s. They were originally hand drawn but were quickly created by computers. A Ribbon Diagram shows the shape of a protein by passing between the alpha-carbons (which are central to the peptide bonds of a polypeptide chain) of each amino-acid. The key part for creating our ribbon diagrams is that it simplifies the thousands of individual atoms down to relatively few points which we need to connect into a shape.</p><figure><a href=https://www.rcsb.org/structure/1igt><input type=checkbox id=zoomCheck-296518437 hidden>
<label for=zoomCheck-296518437><img class=zoomCheck src=/IgG.png alt="The IgG2 antibody of a mouse, left are the input atoms, right is the ribbon diagram"></label></a><figcaption><p><em>The IgG2 antibody of a mouse, left are the input atoms, right is the ribbon diagram</em></p></figcaption></figure><h2 id=reading-protein-files>Reading Protein Files</h2><p>Before we can create our diagrams we first need the atoms which make up our protein, thankfully there is a well established (and documented!) format (PDB) along with a database of proteins called the <a href=https://www.wwpdb.org/>Worldwide Protein Data Bank</a>. While the format is a bit old, it really isn&rsquo;t too bad, <a href=https://github.com/patricklbell/chemical_visualizer/blob/500440aff3c2200fac61c7097174478f0ba4a6a2/src/loader.cpp>my reader (See loadPdbFile)</a> came out at ~300 lines of mutant $C$ and $C\texttt{++}$. Or you could use one of many <a href=https://mmcif.wwpdb.org/docs/software-resources.html>libraries</a> suggested by the PDB people. Either way you now have your atoms and bonds loaded into a nice and pretty data structure. For my online viewer, reading is quick enough that I don&rsquo;t even bother caching anything, the PDB is processed every page load although this could certainly be improved. On to rendering!</p><h2 id=a-brief-word-on-rendering>A Brief Word On Rendering</h2><p>To draw our proteins, like pretty much all 3D graphics, we need to form meshes which the GPU can understand. These meshes consist of triangles, each consisting of three vertices in 3D space which together enclose the ribbon of a protein, for correct lighting we also need a normal for each vertex. I&rsquo;m going to skip over the details of my renderer, ultimately you could draw the meshes with anything you liked or even export 3D models.</p><figure><a href=https://www.rcsb.org/structure/1bzv><input type=checkbox id=zoomCheck-157829364 hidden>
<label for=zoomCheck-157829364><img class=zoomCheck src=/protein-wireframe.png alt="The triangles which make up a Ribbon Diagram"></label></a><figcaption><p><em>The triangles which make up a Ribbon Diagram</em></p></figcaption></figure><h2 id=creating-the-ribbons>Creating The Ribbons</h2><p>Creating a ribbon consists of two steps, fitting a spline to the alpha-carbons and extruding a &lsquo;profile&rsquo; along this spline. A spline takes a pair of points and creates a curve which consists of many points which smoothly move between the pair. To extrude our spline we have to know the normal and tangent at each of these points. A profile is the shape of the ribbon&rsquo;s cross section and can be circular or rectangular.</p><h3 id=the-spline-algorithm>The Spline Algorithm</h3><p>Before creating the spline I first average adjacent alpha-carbon positions to create a smoother look, we then need to choose tangents (parallel to tube) for each point. You could use more chemically accurate tangents but I used a Cardinal interpolation to achieved a smoother look. The Cardinal method uses a dampened vector between adjacent position, so that the tangent is given by</p><p>\[
\Large{\overrightarrow{T_k} = (1-c) (\overrightarrow{P_{k+1}} - \overrightarrow{P_{k-1}})}.
\]<figure><a href=https://www.rcsb.org/structure/1bzv><input type=checkbox id=zoomCheck-652438197 hidden>
<label for=zoomCheck-652438197><img class=zoomCheck src=/protein-cardinal.png alt="Averaged points and their tangents (c = 0.25)"></label></a><figcaption><p><em>Averaged points and their tangents (c = 0.25)</em></p></figcaption></figure></p><p>Now we need to actually generate the spline, it&rsquo;s important that our spline not only smoothly interpolates position but also tangent, normals and binormals. That is, the spline&rsquo;s first and second derivatives must be continuous. Specifying the tangents at each point ensures that adjacent splines have matching first derivatives but not second derivates. If we want we could use a quadratic spline, but we sacrifice smoothness and I found that this produces a poor result. Rather, I discard the true normal and calculate the normal from the current tangent and previous point&rsquo;s normal. For smoothness set the endpoint second derivative to zero, as in the natural Hermite Cubic. This ensures continuity, since the continuity of the tangents are guaranteed and simplifies calculation. If the previous normal is invalid I set the binormal to the perpendicular component, relative to the tangent, of the average of the endpoints&rsquo; binormals, but I&rsquo;m sure there are better choices.</p><p>The position $\overrightarrow{P}$, where $t \in [0, 1]$, is given by
\[
\overrightarrow{P}(t) = (2t^3 - 3t^2 + 1)\overrightarrow{P_{k}} + (-2t^3 + 3t^2)\overrightarrow{P_{k+1}} + (t^3 - 2t^2 + t)\overrightarrow{T_{k}} + (t^3 - t^2)\overrightarrow{T_{k+1}}.
\]
And the tangent $\overrightarrow{T}$ is
\[
\overrightarrow{T}(t) = (6t^2 - 6t)\overrightarrow{P_{k}} + (-6t^2 + 6t)\overrightarrow{P_{k+1}} + (3t^2 - 4t + 1)\overrightarrow{T_{k}} + (3t^2 - 2t)\overrightarrow{T_{k+1}}.
\]
The tangent is then be normalized and used to calculate the binormal and normal
\[
\overrightarrow{B}(t) = T(t) \times N(t - \Delta),\quad \overrightarrow{N}(t) = B(t) \times T(t).
\]</p><p>Or in <a href=https://github.com/patricklbell/chemical_visualizer/blob/500440aff3c2200fac61c7097174478f0ba4a6a2/src/utilities.cpp>code</a> if you prefer (simplified to remove profile blending and doubled normals)</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#6ab825;font-weight:700>auto</span> bref = (b0 + b1) / <span style=color:#3677a9>2.f</span>;
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>for</span>(<span style=color:#6ab825;font-weight:700>int</span> i = <span style=color:#3677a9>0</span>; i &lt; num_points_per_spline; i++) {
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>auto</span> t1 = (<span style=color:#6ab825;font-weight:700>float</span>)i / (num_points_per_spline-<span style=color:#3677a9>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>auto</span> t2 = t1*t1;
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>auto</span> t3 = t1*t2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>auto</span> p = (<span style=color:#3677a9>2</span>*t3-<span style=color:#3677a9>3</span>*t2+<span style=color:#3677a9>1</span>)*pp0 
</span></span><span style=display:flex><span>           + (t3-<span style=color:#3677a9>2</span>*t2+t1)*m0
</span></span><span style=display:flex><span>           + (-<span style=color:#3677a9>2</span>*t3+<span style=color:#3677a9>3</span>*t2)*pp1
</span></span><span style=display:flex><span>           + (t3-t2)*m1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>auto</span> tn = (<span style=color:#3677a9>6</span>*t2-<span style=color:#3677a9>6</span>*t1)*pp0 
</span></span><span style=display:flex><span>            + (<span style=color:#3677a9>3</span>*t2-<span style=color:#3677a9>4</span>*t1+<span style=color:#3677a9>1</span>)*m0
</span></span><span style=display:flex><span>            + (-<span style=color:#3677a9>6</span>*t2+<span style=color:#3677a9>6</span>*t1)*pp1
</span></span><span style=display:flex><span>            + (<span style=color:#3677a9>3</span>*t2-<span style=color:#3677a9>2</span>*t1)*m1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tn = normalize(tn);
</span></span><span style=display:flex><span>    vec3 bn;
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>if</span>(length(prev_normal) &gt; EPSILON) {
</span></span><span style=display:flex><span>        bn = normalize(cross(tn, prev_normal));
</span></span><span style=display:flex><span>    } <span style=color:#6ab825;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        bn = normalize(perpendicularComponent(bref, tn));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>auto</span> n = cross(bn, tn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    projectPointsOnPlane(num_splines, p, bn, n, pf, &amp;points[num_splines*i]);
</span></span><span style=display:flex><span>    projectPointsOnPlane(num_splines, vec3(<span style=color:#3677a9>0</span>), bn, n, pfn, &amp;normals[num_splines*i]);
</span></span><span style=display:flex><span>    prev_normal = n;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><ul class="list-none pl-0 font-sm align-left"><li class=list-none><a class="inline-block mt-2 mr-2 border-none text-neutral-800 dark:text-neutral-200" href=/tags/graphics><span class="flex flex-row justify-start items-center
dark:bg-zinc-900 dark:hover:bg-zinc-700
hover:bg-zinc-200 bg-zinc-100
dark:border-zinc-600 py-0.5
px-1 rounded-t border-b-2 border-zinc-300
hover:border-zinc-500"><img class="h-4 mr-2 inline" src=https://patricklbell.xyz/images/tag_logo.svg alt="Logo of a tag: indicates that a tag item follows.">
Graphics</span></a>
<a class="inline-block mt-2 mr-2 border-none text-neutral-800 dark:text-neutral-200" href=/tags/mathematics><span class="flex flex-row justify-start items-center
dark:bg-zinc-900 dark:hover:bg-zinc-700
hover:bg-zinc-200 bg-zinc-100
dark:border-zinc-600 py-0.5
px-1 rounded-t border-b-2 border-zinc-300
hover:border-zinc-500"><img class="h-4 mr-2 inline" src=https://patricklbell.xyz/images/tag_logo.svg alt="Logo of a tag: indicates that a tag item follows.">
Mathematics</span></a></li></ul><div class="text-neutral-500 mb-4">Last modified <span itemprop=dateModified datetime=2022-12-27T00:00:00Z content="2022-12-27T00:00:00Z">2022.12.27</span></div></article></main><footer class="footer container h-10 text-center mt-1"><ul class="pl-0 mt-1"><li class="first:before:content-none before:content-['•'] inline-block list-none"><a class="rss-link inline-block text-neutral-800 dark:text-neutral-400 border-none" href=https://patricklbell.xyz/posts/index.xml type=application/rss+xml target=_blank>rss</a></li><li class="ml-2 first:before:content-none before:content-['•']
inline-block list-none"><a class="ml-2 text-neutral-800
dark:text-neutral-400 border-none" href=https://github.com/patricklbell>github</a></li><li class="ml-2 first:before:content-none before:content-['•']
inline-block list-none"><a class="ml-2 text-neutral-800
dark:text-neutral-400 border-none" href=/donation/>donate</a></li><li class="ml-2 first:before:content-none before:content-['•']
text-neutral-800 dark:text-neutral-400 inline-block list-none"><span class=ml-2>© Patrick Bell 2022</span></li></ul></footer><link rel=stylesheet href=/js/katex/katex.min.css><script src=/js/katex/katex.min.js></script>
<script src=/js/katex/contrib/auto-render.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"$$",right:"$$",display:!0},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})})</script></body></html>