<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><title>Breaking Down A Graphics Engine - Patrick Bell</title><meta property="og:title" content="Breaking Down A Graphics Engine - Patrick Bell"><meta property="og:type" content="article"><meta property="og:image" content="/FINAL.png"><meta property="og:url" content="https://patricklbell.xyz/posts/visualising-graphics-engines/"><meta property="og:description" content="The homepage of Patrick Bell's blog"><meta name=Description property="description" content="The homepage of Patrick Bell's blog"><meta property="keywords" content="graphics"><link rel=stylesheet href=https://patricklbell.xyz/css/style.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png href=/favicon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link href=https://patricklbell.xyz/index.xml type=application/atom+xml rel=alternate title="Sitewide Atom feed"><meta name=theme-color content="#ffffff"><script>function updateMode(){localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function toggleMode(){localStorage.theme==="dark"?localStorage.theme="light":localStorage.theme="dark",updateMode()}window.onload=updateMode();function toggleMenu(){let e=document.getElementById("navbar-default");e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")}</script></head><body><header class="md:px-0 px-2"><nav><div class="container flex flex-wrap justify-between items-center mx-auto"><div class="nav-main my-2.5"><a href=https://patricklbell.xyz/ class="nav-title py-2.5 text-2xl
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline
text-zinc-600 dark:text-zinc-300 hover:border-b-0">Patrick Bell</a></div><button type=button onclick=toggleMenu() class="inline-flex items-center p-2 ml-3
text-sm text-gray-500
rounded-lg md:hidden hover:bg-gray-100
focus:outline-none focus:ring-2
focus:ring-gray-200 dark:text-gray-400
dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls=navbar-default aria-expanded=false>
<span class=sr-only>Open main menu</span><svg class="w-6 h-6" aria-hidden="true" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></button><div class="hidden w-full md:block md:w-auto" id=navbar-default><ul class="grid md:grid-flow-col items-center justify-between text-lg my-2.5"><li class="p-2.5 md:first:pl-0 dark:border-zinc-500 md:border-none list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/posts/><span class="py-1
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline">Posts</span></a></li><li class="p-2.5 md:first:pl-0 dark:border-zinc-500 md:border-none list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/tags/><span class="py-1
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline">Tags</span></a></li><li class="p-2.5 md:first:pl-0 dark:border-zinc-500 md:border-none list-none"><a class="text-zinc-600 dark:text-zinc-300
hover:border-b-0" href=/about/><span class="py-1
bg-gradient-to-r from-black to-black dark:from-white dark:to-white link-underline">About</span></a></li><li class="h-7 pl-2.5 pr-0 list-none"><button type=button onclick=toggleMode() class=h-full aria-label="Toggle between dark and light mode">
<img class="h-7 w-7 max-h-full mb-1.5 p-1.5 hidden dark:inline" id=ligh-mode-button-img alt="A sun icon for switching to light mode" src=https://patricklbell.xyz/img/light_mode.svg>
<img class="h-7 w-7 max-h-full mb-1.5 p-1.5 inline dark:hidden" id=dark-mode-button-img alt="A moon icon for switching to dark mode" src=https://patricklbell.xyz/img/dark_mode.svg></button></li></ul></div></div></nav><style>.link-underline{border-bottom-width:0;background-size:0 3px;background-position:0 100%;background-repeat:no-repeat;transition:background-size .1s ease-in-out}.link-underline-black{background-image:linear-gradient(transparent,transparent),linear-gradient(#000,#000)}.link-underline-white{background-image:linear-gradient(transparent,transparent),linear-gradient(#fff,#fff)}.link-underline:hover{background-size:100% 3px;background-position:0 100%}</style></header><main class="content h-card container mt-2 m-auto
leading-loose md:px-0 px-2 z-0 break-words" role=main><article class="article h-entry" itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><div class=title-container><h1 class="article-title p-name" itemprop=name>Breaking Down A Graphics Engine</h1><div class="flex justify-between items-center"><a class="text-lg text-gray-600 dark:text-gray-400 border-none u-url" href=https://patricklbell.xyz/posts/visualising-graphics-engines/><time itemprop=datePublished class=dt-published datetime=2022-12-27T00:00:00Z content="2022-12-27T00:00:00Z">2022.12.27</time></a>
<a class="text-gray-600 dark:text-gray-400 text-right border-none p-author h-card" rel=author href=https://patricklbell.xyz/ itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>Patrick Bell</span></a></div></div><div class="article-content e-content" itemprop=articleBody><p><br><figure><input type=checkbox id=zoomCheck-642835917 hidden>
<label for=zoomCheck-642835917><img class=zoomCheck src=/FINAL.png alt="The final composited frame, Crytek&amp;rsquo;s Sponza, a common test scene"></label><figcaption><p><em>The final composited frame, Crytek&rsquo;s Sponza, a common test scene</em></p></figcaption></figure>Game engines such as Unity and Unreal have made 3D graphics more accessible than ever. Unfortunately, in the process they have made it hard to visualize what is actually being drawn to the screen. In essence, how do games look good? To help answer this, I thought I would show each of the processes my own engine takes to create a frame.</p><p><figure><input type=checkbox id=zoomCheck-453216798 hidden>
<label for=zoomCheck-453216798><img class=zoomCheck src=/BASE.png alt="Rendering the mesh with point and directional lighting"></label><figcaption><p><em>Rendering the mesh with point and directional lighting</em></p></figcaption></figure>The first step is rendering all the meshes with their correct materials. This involves switching between shaders to draw meshes with PBR, Blinn-Phong or other lighting models so that they react correctly to the point and directional lights in the scene.</p><h1 id=shadows>Shadows</h1><p><figure><input type=checkbox id=zoomCheck-214673958 hidden>
<label for=zoomCheck-214673958><img class=zoomCheck src=/SHADOWS.png alt="Base render with directional shadows"></label><figcaption><p><em>Base render with directional shadows</em></p></figcaption></figure>To add shadows I sample a cascaded shadow map, this allows the material shader to determine if a point should be in shadow and hence set the directional light contribution to zero.<figure><input type=checkbox id=zoomCheck-814259376 hidden>
<label for=zoomCheck-814259376><img class=zoomCheck src=/CSM.png alt="Nearest slice of the cascaded shadow map"></label><figcaption><p><em>Nearest slice of the cascaded shadow map</em></p></figcaption></figure>The cascaded shadow map is a depth only pass which happens before rendering, it stores the relative depth of geometry from the lights perspective. This can be compared with the scene depth and re-projected into world space to determine if a point is behind the light&rsquo;s view and hence in shadow. If you&rsquo;re curious the <a href=https://github.com/patricklbell/3d_engine/blob/569e867ce7fa31a6845a40d63169516a03f49e12/data/shaders/null.glsl>shadow shader</a> is fairly simple (ignore the vegetation, skeletal animation and clipping) and the <a href=https://github.com/patricklbell/3d_engine/blob/569e867ce7fa31a6845a40d63169516a03f49e12/data/shaders/lib/shadows.glsl>sampling</a> which is a bit harder to understand.</p><h1 id=volumetrics>Volumetrics</h1><p><figure><input type=checkbox id=zoomCheck-358627419 hidden>
<label for=zoomCheck-358627419><img class=zoomCheck src=/VOLUMETRICS.png alt="Volumetric fog"></label><figcaption><p><em>Volumetric fog</em></p></figcaption></figure>Each point also samples an accumulated volumetric fog color which is added to the resulting color. This adds a sense of depth to the lighting by roughly approximating in scattering due to the particulates in the atmosphere (such as the small water droplets in fog). It also adds ambient some extra ambient lighting.<figure><input type=checkbox id=zoomCheck-513269748 hidden>
<label for=zoomCheck-513269748><img class=zoomCheck src=/INTEGRATED_VOLUME.png alt="A slice of the raymarched volumetric 3D texture"></label><figcaption><p><em>A slice of the raymarched volumetric 3D texture</em></p></figcaption></figure>This accumulated color is computed by marching rays through the camera&rsquo;s frustrum, accumulating color and density in a low resolution 3D texture. This technique was created for EA&rsquo;s frostbite engine which they <a href=https://www.ea.com/frostbite/news/physically-based-unified-volumetric-rendering-in-frostbite>documented</a> or you can see my own compute shaders: the <a href=https://github.com/patricklbell/3d_engine/blob/569e867ce7fa31a6845a40d63169516a03f49e12/data/shaders/volumetric_integration.glsl>volume integration</a> and <a href=https://github.com/patricklbell/3d_engine/blob/569e867ce7fa31a6845a40d63169516a03f49e12/data/shaders/volumetric_raymarch.glsl>raymarching</a></p><h1 id=post-processing>Post Processing</h1><p>Most of these effects should be familiar, since they are usually configurable in video games. Antialiasing reduces the jagged edges created during the rasterisation process. Bloom adds a blur to bright regions caused by a saturation of the light sensing cells in our eyes. Eye exposure correction approximates the contraction and dilation of our pupils when its bright or dark, similar to how a film camera can automatically adjust it&rsquo;s exposure. Tonemapping and Gamma correction are processing unique to displaying an image on a computer. Tonemapping compresses the floating point colors we have been using into the 0-1 range of a monitor, Gamma correct then converts the linear brightness to a curve which fits the monitor&rsquo;s pixel true brightness. All these post processing steps are fairly simple, if fiddly, and can be found in a <a href=https://github.com/patricklbell/3d_engine/blob/569e867ce7fa31a6845a40d63169516a03f49e12/data/shaders/post.glsl>single shader</a> for my engine.</p><p><figure><input type=checkbox id=zoomCheck-485167923 hidden>
<label for=zoomCheck-485167923><img class=zoomCheck src=/AA.png alt="Fast Approximate Anti Aliasing (FXAA) and multisampling"></label><figcaption><p><em>Fast Approximate Anti Aliasing (FXAA) and multisampling</em></p></figcaption></figure><figure><input type=checkbox id=zoomCheck-948713652 hidden>
<label for=zoomCheck-948713652><img class=zoomCheck src=/BLOOM.png alt="Additive blending with bloom texture"></label><figcaption><p><em>Additive blending with bloom texture</em></p></figcaption></figure><figure><input type=checkbox id=zoomCheck-293786145 hidden>
<label for=zoomCheck-293786145><img class=zoomCheck src=/SSAO.png alt="Screen space ambient occlusion, very subtle due to large error"></label><figcaption><p><em>Screen space ambient occlusion, very subtle due to large error</em></p></figcaption></figure></p><figure><input type=checkbox id=zoomCheck-218945763 hidden>
<label for=zoomCheck-218945763><img class=zoomCheck src=/EXPOSURE-TONEMAPPING-GAMMA.png alt="Eye exposure correction, Uncharted 2 Tonemapping, Gamma correction"></label><figcaption><p><em>Eye exposure correction, Uncharted 2 Tonemapping, Gamma correction</em></p></figcaption></figure><figure><input type=checkbox id=zoomCheck-182654739 hidden>
<label for=zoomCheck-182654739><img class=zoomCheck src=/FINAL.png alt="A simple vignette, darkens screen corners"></label><figcaption><p><em>A simple vignette, darkens screen corners</em></p></figcaption></figure></div><ul class="list-none pl-0 font-sm align-left"><li class=list-none><a class="inline-block mt-2 mr-2 border-none text-neutral-800 dark:text-neutral-200" href=/tags/graphics><span class="flex flex-row justify-start items-center
dark:bg-zinc-900 dark:hover:bg-zinc-700
hover:bg-zinc-200 bg-zinc-100
dark:border-zinc-600 py-0.5
px-1 rounded-t border-b-2 border-zinc-300
hover:border-zinc-500"><img class="h-4 mr-2 inline" src=https://patricklbell.xyz/images/tag_logo.svg alt="Logo of a tag: indicates that a tag item follows.">
Graphics</span></a></li></ul><div class="text-neutral-500 mb-4">Last modified <span itemprop=dateModified datetime=2022-12-27T00:00:00Z content="2022-12-27T00:00:00Z">2022.12.27</span></div></article></main><footer class="footer container h-10 text-center mt-1"><ul class="pl-0 mt-1"><li class="first:before:content-none before:content-['•'] inline-block list-none"><a class="rss-link inline-block text-neutral-800 dark:text-neutral-400 border-none" href=https://patricklbell.xyz/posts/index.xml type=application/rss+xml target=_blank>rss</a></li><li class="ml-2 first:before:content-none before:content-['•']
inline-block list-none"><a class="ml-2 text-neutral-800
dark:text-neutral-400 border-none" href=https://github.com/patricklbell>github</a></li><li class="ml-2 first:before:content-none before:content-['•']
inline-block list-none"><a class="ml-2 text-neutral-800
dark:text-neutral-400 border-none" href=/donation/>donate</a></li><li class="ml-2 first:before:content-none before:content-['•']
text-neutral-800 dark:text-neutral-400 inline-block list-none"><span class=ml-2>© Patrick Bell 2022</span></li></ul></footer></body></html>